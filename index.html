<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Form Order Kerja - PT. DAGSAP ENDURA EATORE</title>
  <!-- PDF Export Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    .container { max-width: 1200px; margin: auto; background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);}
    table { width: 100%; border-collapse: collapse; margin-bottom: 10px;}
    th,td { border:1px solid #ddd; padding:8px; vertical-align:top; }
    th { background:#4CAF50; color:#fff; }
    .table-title{font-weight:bold;margin:10px 0;}
    .field-name{background:#e8f5e8; width:200px;}
    .qr-code{width:50px;height:50px;}
    .image-container{position:relative;width:400px;height:300px;margin:auto;border:1px solid #ddd;}
    .dynamic-image{width:100%;height:100%;object-fit:contain;}
    .buttons{text-align:center;margin:20px;}
    .btn{padding:8px 16px;border:none;border-radius:5px;cursor:pointer;margin:4px;}
    .btn-success{background:#28a745;color:#fff;}
    .btn-warning{background:#ffc107;color:#000;}
    .loading-spinner{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:9999;}
    .spinner{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #007bff;border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin{0%{transform:translate(-50%,-50%) rotate(0)}100%{transform:translate(-50%,-50%) rotate(360deg)}}
    .page-break { page-break-before: always; }
    .name-row td { font-size: 12px; border: none; text-align: center; }
    .checkbox-label { cursor: pointer; }
    .status { font-weight:bold; padding:4px 8px; border-radius:4px; color:#fff; display:inline-block; }
    .status-selesai { background:#28a745; }
    .status-proses { background:#ffc107; color:#000; }
    .status-pending { background:#dc3545; }
    .status-default { background:#6c757d; }
  </style>
</head>
<body>
  <div id="loadingSpinner" class="loading-spinner">
    <div class="spinner"></div>
  </div>

  <div class="container">
    <div id="printArea">
      <table class="header-table">
        <tr>
          <td rowspan="2" style="text-align:center;">
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRYyanHkNjy-MEGWx-yRWA8XiFF9HbWiLoGFY9HRkEpuBXKYGjxU_TMW2dK4ONcqKA4tg&usqp=CAU" 
                 width="100" height="60" crossorigin="anonymous">
            <div><b>PT.DAGSAP ENDURA EATORE</b></div>
          </td>
          <td><b>FORM ORDER KERJA (OK)</b></td>
        </tr>
      </table>

      <div class="table-title">Detail Order Kerja</div>
      <table class="body-table">
        <tr><td class="field-name">No. OK</td><td id="noOK">-</td></tr>
        <tr><td class="field-name">Department</td><td id="department">-</td></tr>
        <tr><td class="field-name">Nama</td><td id="nama">-</td></tr>
        <tr><td class="field-name">Nama Sifat Pekerjaan</td><td id="namaKerja">-</td></tr>
        <tr><td class="field-name">Jenis Pekerjaan</td><td id="jenisKerja">-</td></tr>
        <tr><td class="field-name">Target Selesai</td><td id="targetSelesai">-</td></tr>
        <tr><td class="field-name">Aktual Selesai</td><td id="actualSelesai">-</td></tr>
        <tr><td class="field-name">Status</td><td id="statusCell"><span id="status">-</span></td></tr>
      </table>

      <!-- Checklist -->
      <div class="table-title">Checklist Verifikasi</div>
      <table class="body-table">
        <tr>
          <td style="width:50px;text-align:center;"><input type="checkbox" id="check1" disabled></td>
          <td><label for="check1" class="checkbox-label">Cek kebersihan mesin dan area mesin oleh QC</label></td>
        </tr>
        <tr>
          <td style="width:50px;text-align:center;"><input type="checkbox" id="check2" disabled></td>
          <td><label for="check2" class="checkbox-label">Cek kelengkapan mesin dan kelengkapan alat oleh operator produksi dan teknisi</label></td>
        </tr>
        <tr>
          <td style="width:50px;text-align:center;"><input type="checkbox" id="check3" disabled></td>
          <td><label for="check3" class="checkbox-label">Serah terima mesin oleh teknisi kepada operator produksi</label></td>
        </tr>
      </table>

      <!-- Foto 1 & 2 -->
      <div class="page-break table-title">Lampiran Foto Halaman 2</div>
      <table>
        <tr>
          <td class="field-name">Foto 1</td>
          <td><div class="image-container"><img id="image1" class="dynamic-image" crossorigin="anonymous"></div></td>
        </tr>
        <tr>
          <td class="field-name">Foto 2</td>
          <td><div class="image-container"><img id="image2" class="dynamic-image" crossorigin="anonymous"></div></td>
        </tr>
      </table>

      <!-- Foto 3 & 4 -->
      <div class="page-break table-title">Lampiran Foto Halaman 3</div>
      <table>
        <tr>
          <td class="field-name">Foto 3</td>
          <td><div class="image-container"><img id="image3" class="dynamic-image" crossorigin="anonymous"></div></td>
        </tr>
        <tr>
          <td class="field-name">Foto 4</td>
          <td><div class="image-container"><img id="image4" class="dynamic-image" crossorigin="anonymous"></div></td>
        </tr>
      </table>

      <!-- QR Code + Nama -->
      <table class="footer-table">
        <tr>
          <td><img id="qr1" class="qr-code" crossorigin="anonymous"></td>
          <td><img id="qr2" class="qr-code" crossorigin="anonymous"></td>
          <td><img id="qr3" class="qr-code" crossorigin="anonymous"></td>
          <td><img id="qr4" class="qr-code" crossorigin="anonymous"></td>
          <td><img id="qr5" class="qr-code" crossorigin="anonymous"></td>
        </tr>
        <tr class="name-row">
          <td id="name1">-<br>-</td>
          <td id="name2">-<br>-</td>
          <td id="name3">-<br>-</td>
          <td id="name4">-<br>-</td>
          <td id="name5">-<br>-</td>
        </tr>
      </table>
    </div>

    <div class="buttons">
      <button class="btn btn-success" onclick="exportToPDF()">Export PDF</button>
      <button class="btn btn-warning" onclick="exportToPDF(true)">Export PDF (HQ)</button>
    </div>
  </div>

<script>
// ambil parameter dari URL
function getUrlParameter(name) {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(name) || '';
}

// isi data ke form
(function(){
  const params = {
    noOK: getUrlParameter('noOK') || '-',
    department: getUrlParameter('department') || '-',
    nama: getUrlParameter('nama') || '-',
    namaKerja: getUrlParameter('namaKerja') || '-',
    jenisKerja: getUrlParameter('jenisKerja') || '-',
    targetSelesai: getUrlParameter('targetSelesai') || '-',
    actualSelesai: getUrlParameter('actualSelesai') || '-',
    status: getUrlParameter('status') || '-',
    image1: getUrlParameter('image1') || '',
    image2: getUrlParameter('image2') || '',
    image3: getUrlParameter('image3') || '',
    image4: getUrlParameter('image4') || '',
    check1: getUrlParameter('check1') || 'false',
    check2: getUrlParameter('check2') || 'false',
    check3: getUrlParameter('check3') || 'false',
    sig1: getUrlParameter('sig1') || '',
    sig2: getUrlParameter('sig2') || '',
    sig3: getUrlParameter('sig3') || '',
    sig4: getUrlParameter('sig4') || '',
    sig5: getUrlParameter('sig5') || '',
    name1: getUrlParameter('name1') || '',
    name2: getUrlParameter('name2') || '',
    name3: getUrlParameter('name3') || '',
    name4: getUrlParameter('name4') || '',
    name5: getUrlParameter('name5') || ''
  };

  // isi teks form
  document.getElementById('noOK').innerText = params.noOK;
  document.getElementById('department').innerText = params.department;
  document.getElementById('nama').innerText = params.nama;
  document.getElementById('namaKerja').innerText = params.namaKerja;
  document.getElementById('jenisKerja').innerText = params.jenisKerja;
  document.getElementById('targetSelesai').innerText = params.targetSelesai;
  document.getElementById('actualSelesai').innerText = params.actualSelesai;

  // status
  setupStatus(params.status);

  // ceklis
  setupCheckbox('check1', params.check1);
  setupCheckbox('check2', params.check2);
  setupCheckbox('check3', params.check3);

  // gambar
  setupImage('image1', params.image1);
  setupImage('image2', params.image2);
  setupImage('image3', params.image3);
  setupImage('image4', params.image4);

  // QR
  setupQRCode('qr1', params.sig1 || params.name1 || 'Diminta Oleh');
  setupQRCode('qr2', params.sig2 || params.name2 || 'Menyetujui');
  setupQRCode('qr3', params.sig3 || params.name3 || 'Pelaksana');
  setupQRCode('qr4', params.sig4 || params.name4 || 'Diketahui');
  setupQRCode('qr5', params.sig5 || params.name5 || 'Diterima Oleh');

  // Nama di bawah QR
  setupNameDisplay('name1', params.name1, params.sig1);
  setupNameDisplay('name2', params.name2, params.sig2);
  setupNameDisplay('name3', params.name3, params.sig3);
  setupNameDisplay('name4', params.name4, params.sig4);
  setupNameDisplay('name5', params.name5, params.sig5);
})();

// fungsi status
function setupStatus(status){
  const statusEl = document.getElementById('status');
  let cls = 'status-default';
  let text = status;
  if(!status || status==='-'){ text='-'; cls='status-default'; }
  else if(status.toLowerCase()==='selesai'){ cls='status-selesai'; }
  else if(status.toLowerCase()==='proses'){ cls='status-proses'; }
  else if(status.toLowerCase()==='pending'){ cls='status-pending'; }
  statusEl.className = 'status '+cls;
  statusEl.innerText = text;
}

// fungsi pasang checkbox
function setupCheckbox(id, value){
  const el=document.getElementById(id);
  if(el){ el.checked = (value.toLowerCase()==='true' || value==='1'); }
}

// fungsi pasang gambar
function setupImage(imageId, url){
  if(!url) return;
  const img=document.getElementById(imageId);
  img.crossOrigin="anonymous";
  img.src=decodeURIComponent(url);
}

// fungsi QR code
function setupQRCode(qrId,data){
  const qr=document.getElementById(qrId);
  qr.crossOrigin="anonymous";
  qr.src=`https://api.qrserver.com/v1/create-qr-code/?size=50x50&data=${encodeURIComponent(data)}`;
}

// fungsi nama di bawah QR
function setupNameDisplay(nameId, nameParam, sigParam){
  const el=document.getElementById(nameId);
  if(!el) return;
  let displayText="-<br>-";
  if(nameParam){
    const parts=decodeURIComponent(nameParam).split(' - ');
    displayText = parts.length>=2 ? `${parts[0]}<br>${parts[1]}` : nameParam.replace(/\s+/g,'<br>');
  } else if(sigParam){
    const parts=decodeURIComponent(sigParam).split(' - ');
    displayText = parts.length>=2 ? `${parts[0]}<br>${parts[1]}` : sigParam.replace(/\s+/g,'<br>');
  }
  el.innerHTML=displayText;
}

// export PDF
function exportToPDF(highQuality=false){
  const { jsPDF } = window.jspdf;
  const element=document.getElementById('printArea');
  const spinner=document.getElementById('loadingSpinner');
  spinner.style.display='block';

  const opt={ scale:highQuality?3:2, useCORS:true, allowTaint:false, backgroundColor:'#fff' };

  html2canvas(element,opt).then(canvas=>{
    const imgData=canvas.toDataURL('image/png',1.0);
    const pdf=new jsPDF('p','mm','a4');
    const pdfW=210, pdfH=297, margin=10;
    const imgW=pdfW-(margin*2);
    const imgH=(canvas.height*imgW)/canvas.width;
    let heightLeft=imgH, position=margin;
    pdf.addImage(imgData,'PNG',margin,position,imgW,imgH);
    heightLeft-=(pdfH-margin*2);
    while(heightLeft>0){
      position=heightLeft-imgH+margin;
      pdf.addPage();
      pdf.addImage(imgData,'PNG',margin,position,imgW,imgH);
      heightLeft-=(pdfH-margin*2);
    }
    pdf.save("Form_Order_Kerja.pdf");
    spinner.style.display='none';
  }).catch(err=>{
    console.error(err);
    spinner.style.display='none';
  });
}
</script>
</body>
</html>
